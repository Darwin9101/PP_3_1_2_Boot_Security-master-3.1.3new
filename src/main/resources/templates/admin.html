<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>Пользователи</title>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Админ Панель</a>
    <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="btn btn-danger" href="/logout">Выход</a> <!-- Заменено на ссылку -->
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="text-center">Управление пользователями</h2>

    <div class="mb-3">
        <button class="btn btn-primary" id="addUserButton" data-toggle="modal" data-target="#userModal">Добавить пользователя</button>
    </div>

    <table class="table table-bordered" id="userTable">
        <thead class="thead-light">
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Email</th>
            <th>Роли</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
    </table>
</div>

<!-- Модальное окно для добавления и редактирования пользователя -->
<div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Добавить пользователя</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="name">Имя</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Роли</label>
                        <select multiple id="roles" class="form-control"></select>
                    </div>
                    <button type="submit" class="btn btn-success">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    const userTableBody = document.getElementById('userTableBody');

    async function loadUsers() {
        const response = await fetch('/admin/api/users');
        const users = await response.json();
        userTableBody.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.roles.map(role => role.name).join(', ')}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">Изменить</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Удалить</button>
                </td>
            `;
            userTableBody.appendChild(row);
        });
    }

    async function loadRoles() {
        const response = await fetch('/admin/api/roles');
        const roles = await response.json();
        const rolesSelect = document.getElementById('roles');
        rolesSelect.innerHTML = '';
        roles.forEach(role => {
            rolesSelect.append(new Option(role.name, role.id));
        });
    }

    document.getElementById('addUserButton').onclick = function() {
        document.getElementById('userModalLabel').innerText = 'Добавить пользователя';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        loadRoles();
    };

    async function editUser(id) {
        const response = await fetch(`/admin/api/users/${id}`);
        const user = await response.json();
        document.getElementById('userId').value = user.id;
        document.getElementById('name').value = user.name;
        document.getElementById('email').value = user.email;

        const rolesSelect = document.getElementById('roles');
        const selectedRoles = user.roles.map(role => role.id);
        for (let option of rolesSelect.options) {
            option.selected = selectedRoles.includes(Number(option.value));
        }

        document.getElementById('userModalLabel').innerText = 'Редактировать пользователя';
        $('#userModal').modal('show');
    }

    document.getElementById('userForm').onsubmit = async function(event) {
        event.preventDefault();
        const userId = document.getElementById('userId').value;
        const userData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            roles: Array.from(document.getElementById('roles').selectedOptions).map(option => ({ id: option.value }))
        };

        if (userId) {
            await fetch(`/admin/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        } else {
            await fetch('/admin/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        }

        $('#userModal').modal('hide');
        loadUsers();
    };

    async function deleteUser(id) {
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            await fetch(`/admin/api/users/${id}`, { method: 'DELETE' });
            loadUsers();
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadUsers();
        await loadRoles();
    });
</script>
</body>
</html>